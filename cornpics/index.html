<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CornPics</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/5.3.7/photoswipe.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/masonry/4.2.2/masonry.pkgd.min.js"></script>
</head>
<body>
  <header>
    <div class="header-container">
      <img src="https://static.pornpics.com/style/img/logo-w.svg" alt="CornPics" class="logo">
      <div class="search-form">
        <button class="button" id="fetch-next">Fetch Next</button>
      </div>
    </div>
    <div class="nav-container">
      <div class="url"></div>
    </div>
  </header>

  <main>
    <div class="grid">
    </div>
  </main>

  <script type="module">
    import PhotoSwipe from 'https://cdnjs.cloudflare.com/ajax/libs/photoswipe/5.3.7/photoswipe.esm.min.js'

    class Site {
      constructor() {
        this.search_keywords = '';
        this.search_keywords_elem = $('<input>').addClass('input')
                                                .addClass('search_keywords')
                                                .attr('type', 'text');
        $('.search-form').append(this.search_keywords_elem);
        this.latest = false;
        this.limit = 20;
        this.offset = 0;
      }
      get_url() {
        this.search_keywords = $('.search_keywords').val();
        return `https://www.pornpics.com/search/srch.php` + 
               `?q=${encodeURIComponent(this.search_keywords)}` +
               `${this.latest ? '&date=latest' : ''}` +
               `&limit=${this.limit}` +
               `&offset=${this.offset}`;
      }
      get_title_str(data) {
        return $(data).find('.title-section h1').text();
      }
      get_info_dict(data) {
        return {
          'Channel:': $(data).find(".gallery-info__item").eq(0).find("a").map(function () {
            return $(this).text();
          }).get(),
          'Models:': $(data).find(".gallery-info__item").eq(1).find("a").map(function () {
            return $(this).text();
          }).get(),
          'Categories:': $(data).find(".gallery-info__item.tags").eq(0).find("a").map(function () {
            return $(this).text();
          }).get(),
          'Tags List': $(data).find(".gallery-info__item.tags").eq(1).find("a").map(function () {
            return $(this).text();
          }).get(),
        };
      }
      get_image_elements(data) {
        return $(data).find('#main ul li a');
      }
      get_image(element) {
        const src = $(element).attr('href');
        const [width, height] = $(element).attr('data-size').split('x');
        return {
          src: src,
          width: width,
          height: height
        };
      }
      set_vars(kws) {
        this.search_keywords = kws;
        this.search_keywords_elem.val(kws);
        this.search_keywords_elem.trigger('change');
      }
      set_first_page() {
        this.offset = 0;
      }
      set_next_page() {
        this.offset += this.limit;
      }
    }

    const site = new Site();

    const grid = $('.grid').masonry({
      itemSelector: '.grid-item',
      fitWidth: true
    });

    async function get_inner(url) {
      const image_list = [];
      const data = await $.ajax({url: url});
      const image_elements = site.get_image_elements(data);
      const title_str = site.get_title_str(data);
      image_elements.each(function () {
        image_list.push(site.get_image(this));
      });
      const info_dict = site.get_info_dict(data);
      return [title_str, info_dict, image_list];
    }

    function get_info(info_dict) {
      const info = $('<div>').addClass('info');
      for (const [key, element_list] of Object.entries(info_dict)) {
        if (element_list.length === 0) {
          continue;
        }
        const info_title = $('<div>').addClass('info-title').text(key);
        const info_buttons = $('<div>').addClass('info-button-container');
        element_list.forEach(element => {
          info_buttons.append(
            $('<button>').addClass('info-button').text(element).on('click', () => {
              site.set_vars(element);
            })
          );
        });
        const info_row = $('<div>').addClass('info-row').append(info_title).append(info_buttons);
        info.append(info_row);
      }
      return info;
    }

    async function get_galleries(url) {
      const data = await $.ajax({url: url});
      const processed_data = $.parseJSON(data);
      processed_data.forEach(async (element) => {
        const [title_str, info_dict, image_list] = await get_inner(element.g_url);
        const title = $('<div>')
            .addClass('gallery-title-container')
            .append(
              $('<div>').addClass('gallery-title')
                        .text(title_str)
            );
        const img = $('<img>')
            .attr('src', element.t_url_460)
            .attr('alt', element.desc)
            .on('click', () => {
              const pswp = new PhotoSwipe({dataSource: image_list});
              pswp.init();
            })
            .on('load', () => {
              grid.masonry('layout');
            });
        const info = get_info(info_dict);
        const grid_item = $('<div>')
            .addClass('grid-item')
            .append(title)
            .append(img)
            .append(info);
        grid.append(grid_item).masonry('appended', grid_item);
      }); 
    }

    function clear_galleries() {
      grid.masonry('remove', grid.find('.grid-item'));
      grid.empty();
    }

    function update_url() {
      const url = site.get_url();
      $('.url').text(url);
      return url;
    }

    $('.input').on('change', function() {
      site.set_first_page();
      clear_galleries();
      get_galleries(update_url());
      window.scrollTo(0, 0);
    });

    $('#fetch-next').on('click', function() {
      site.set_next_page();
      clear_galleries();
      get_galleries(update_url());
    });
  </script>
</body>
</html>
