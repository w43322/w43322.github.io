<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CornPics</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/5.3.7/photoswipe.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/masonry/4.2.2/masonry.pkgd.min.js"></script>
</head>
<body>
  <header>
    <div class="header-container">
      <img src="https://static.pornpics.com/style/img/logo-w.svg" alt="CornPics" class="logo">
      <div class="search-form">
        <input type="text" placeholder="Search" class="input search-keywords">
        <button class="button" id="fetch-next">Fetch Next</button>
      </div>
    </div>
    <div class="nav-container">
      <div class="url"></div>
    </div>
  </header>

  <main>
    <div class="grid">
    </div>
  </main>

  <script type="module">
    import PhotoSwipe from 'https://cdnjs.cloudflare.com/ajax/libs/photoswipe/5.3.7/photoswipe.esm.min.js'

    let LIMIT = 20;
    let OFFSET = 0;

    const grid = $('.grid').masonry({
      itemSelector: '.grid-item',
      fitWidth: true
    });

    async function get_inner(url) {
      const image_list = [];
      const data = await $.ajax({url: url});
      const image_elements = $(data).find('#main ul li a');
      const title_str = $(data).find('.title-section h1').text();
      image_elements.each(function () {
        const src = $(this).attr('href');
        const [width, height] = $(this).attr('data-size').split('x');
        image_list.push({
          src: src,
          width: width,
          height: height
        });
      });
      const info_dict = {
        'Channel:': $(data).find(".gallery-info__item").eq(0).find("a").map(function () {
          return $(this).text();
        }).get(),
        'Models:': $(data).find(".gallery-info__item").eq(1).find("a").map(function () {
          return $(this).text();
        }).get(),
        'Categories:': $(data).find(".gallery-info__item.tags").eq(0).find("a").map(function () {
          return $(this).text();
        }).get(),
        'Tags List': $(data).find(".gallery-info__item.tags").eq(1).find("a").map(function () {
          return $(this).text();
        }).get(),
      }
      return [title_str, info_dict, image_list];
    }

    function get_info(info_dict) {
      const info = $('<div>').addClass('info');
      for (const [key, element_list] of Object.entries(info_dict)) {
        if (element_list.length === 0) {
          continue;
        }
        const info_title = $('<div>').addClass('info-title').text(key);
        const info_buttons = $('<div>').addClass('info-button-container');
        element_list.forEach(element => {
          info_buttons.append(
            $('<button>').addClass('info-button').text(element).on('click', () => {
              $('.search-keywords').val(element).trigger('change')
            })
          );
        });
        const info_row = $('<div>').addClass('info-row').append(info_title).append(info_buttons);
        info.append(info_row);
      }
      return info;
    }

    async function get_galleries(url) {
      const data = await $.ajax({url: url});
      const processed_data = $.parseJSON(data);
      processed_data.forEach(async (element) => {
        const [title_str, info_dict, image_list] = await get_inner(element.g_url);
        const title = $('<div>')
            .addClass('gallery-title-container')
            .append(
              $('<div>').addClass('gallery-title')
                        .text(title_str)
            );
        const img = $('<img>')
            .attr('src', element.t_url_460)
            .attr('alt', element.desc)
            .on('click', () => {
              const pswp = new PhotoSwipe({dataSource: image_list});
              pswp.init();
            })
            .on('load', () => {
              grid.masonry('layout');
            });
        const info = get_info(info_dict);
        const grid_item = $('<div>')
            .addClass('grid-item')
            .append(title)
            .append(img)
            .append(info);
        grid.append(grid_item).masonry('appended', grid_item);
      }); 
    }

    function clear_galleries() {
      grid.masonry('remove', grid.find('.grid-item'));
      grid.empty();
    }

    function get_url() {
      const prefix = 'https://www.pornpics.com/search/srch.php?';
      const params = {
        q: $('.search-keywords').val(),
        limit: LIMIT,
        offset: OFFSET
      };
      const suffix = Object.keys(params)
          .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)
          .join('&');
      const url = prefix + suffix;
      $('.url').text(url);
      return url;
    }

    $('.search-keywords').on('change', function() {
      OFFSET = 0;
      clear_galleries();
      get_galleries(get_url());
      window.scrollTo(0, 0);
    });

    $('#fetch-next').on('click', function() {
      OFFSET += LIMIT;
      clear_galleries();
      get_galleries(get_url());
    });
  </script>
</body>
</html>
